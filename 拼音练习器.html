<!--
ä¿å­˜è¯´æ˜ï¼ˆé‡è¦ï¼‰ï¼š
1. å¤åˆ¶å…¨éƒ¨å†…å®¹åˆ°æ–‡æœ¬ç¼–è¾‘å™¨ï¼ˆä¾‹å¦‚è®°äº‹æœ¬ã€VSCodeï¼‰ã€‚
2. å¦å­˜ä¸ºï¼špinyin_practice.html
   - æ–‡ä»¶ç¼–ç ï¼šUTF-8
   - æ–‡ä»¶ç±»å‹ï¼šæ‰€æœ‰æ–‡ä»¶ï¼ˆAll Filesï¼‰
3. åŒå‡»è¯¥æ–‡ä»¶å³å¯åœ¨é»˜è®¤æµè§ˆå™¨ä¸­æ‰“å¼€å¹¶ç¦»çº¿ä½¿ç”¨ï¼ˆæ— éœ€å®‰è£…ï¼‰ã€‚

è¯´æ˜ï¼ˆè¯·å…ˆé˜…è¯»ï¼‰ï¼š
- æœ¬å•æ–‡ä»¶ç½‘é¡µå®ç°å®Œæ•´çš„â€œæ‹¼éŸ³ç»ƒä¹ å™¨â€ï¼š
  - åˆ†å±‚æ¨¡å—ï¼šå£°æ¯è¯†åˆ« / éŸµæ¯è¯†åˆ« / å®Œæ•´æ‹¼éŸ³ï¼ˆå¬/çœ‹é€‰æ‹¼éŸ³ï¼‰ / å£°è°ƒè¾¨åˆ« / æƒ…å¢ƒåº”ç”¨ï¼ˆæ‹¼éŸ³é”®ç›˜è¾“å…¥ï¼‰ã€‚
  - å³æ—¶åé¦ˆã€é”™é¢˜å¤ä¹ é˜Ÿåˆ—ï¼ˆlocalStorage ä¿å­˜ï¼‰ã€é”™é¢˜çƒ­æ¦œã€ä¼šè¯æ—¥å¿—ã€è¿›åº¦æ¡ã€é¢˜æ•°é€‰æ‹©ç­‰åŠŸèƒ½ã€‚
  - å‘éŸ³ä½¿ç”¨æµè§ˆå™¨ SpeechSynthesisï¼Œé»˜è®¤ä¼˜å…ˆé€‰æ‹©æ™®é€šè¯ï¼ˆzh-CNï¼‰ã€‚
  - æƒ…å¢ƒåº”ç”¨æ¨¡å—æä¾›å†…ç½®æ‹¼éŸ³é”®ç›˜ï¼ˆåŒ…å«å¸¦è°ƒæ¯éŸ³ï¼‰ï¼Œç”¨æˆ·é€šè¿‡ç‚¹å‡»æŒ‰é’®è¾“å…¥å¸¦å£°è°ƒçš„æ‹¼éŸ³å¹¶æäº¤ï¼Œé¡µé¢ä¼šä¸è¯æ¡çš„å¸¦è°ƒæ‹¼éŸ³ä¸¥æ ¼åŒ¹é…ï¼ˆå¿½ç•¥å¤§å°å†™ä¸ç©ºæ ¼ï¼‰ã€‚
- å…³äº **HSK1 + HSK2ï¼ˆå…± 320 è¯ï¼‰è¯åº“ä¸è¶Šå—è¯­é‡Šä¹‰**ï¼š
  - ä¸ºäº†ä¿è¯è¶Šå—è¯­é‡Šä¹‰çš„å‡†ç¡®æ€§ï¼Œé¡µé¢å†…æä¾›äº†**å¯¼å…¥ CSV** åŠŸèƒ½ï¼ˆåŒ…å«ä¸‰åˆ—ï¼šhanzi,pinyin,vnï¼‰ã€‚ä½ å¯ä»¥å‡†å¤‡åŒ…å« 320 æ¡ HSK1+HSK2 çš„ CSV æ–‡ä»¶å¹¶é€šè¿‡é¡µé¢å¯¼å…¥ï¼Œé¡µé¢ä¼šæ›¿æ¢å½“å‰è¯åº“å¹¶ä¿å­˜åˆ° localStorageã€‚
  - æˆ‘æ²¡æœ‰é¢„å…ˆæŠŠ 320 æ¡å¸¦å‡†ç¡®è¶Šå—è¯­é‡Šä¹‰çš„è¯æ¡ç¡¬ç¼–ç åˆ°é¡µé¢ï¼Œä»¥é¿å…ç¿»è¯‘é”™è¯¯ã€‚é¡µé¢å†…å·²åŒ…å«å°‘é‡ç¤ºä¾‹è¯æ¡ï¼›ä½ å¯å¯¼å…¥å®Œæ•´è¯åº“ï¼ˆCSV æ ¼å¼ï¼‰æ¥ç«‹å³ä½¿ç”¨ã€‚
  - åœ¨ä»£ç åº•éƒ¨æ³¨é‡Šä¸­æœ‰ç¤ºä¾‹ CSV æ ¼å¼è¯´æ˜å’Œå¦‚ä½•æŠŠé¢„å½•éŸ³ï¼ˆaudioï¼‰å­—æ®µåŠ å…¥è¯æ¡ä»¥æ›¿ä»£ TTSã€‚
- å¦‚æœä½ å¸Œæœ›æˆ‘ç›´æ¥æŠŠ 320 æ¡è¯ï¼ˆå«è¶Šå—è¯­è§£é‡Šï¼‰ç¡¬ç¼–ç è¿›æ–‡ä»¶ï¼Œè¯·å›å¤ç¡®è®¤ï¼ˆæ³¨æ„ï¼šæˆ‘éœ€è¦æ—¶é—´æ¥ç”Ÿæˆ/æ ¡å¯¹è¿™äº›ç¿»è¯‘ï¼›å»ºè®®åˆ†æ‰¹å¤„ç†ä»¥ç¡®ä¿å‡†ç¡®æ€§ï¼‰ã€‚

ä»¥ä¸‹ä¸ºå®Œæ•´ HTML å•æ–‡ä»¶ä»£ç ï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½ä¸å¯¼å…¥å·¥å…·ï¼š
-->
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ‹¼éŸ³ç»ƒä¹ å™¨ Â· åˆ†å±‚ç»ƒä¹ ï¼ˆæ”¯æŒå¯¼å…¥ HSK1+HSK2 CSVï¼‰</title>
<style>
:root{
  --bg:#f5f8ff; --panel:#fff; --primary:#2563eb; --accent:#06b6d4; --ok:#16a34a; --err:#ef4444; --muted:#64748b;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Microsoft YaHei",PingFang SC;background:var(--bg);color:#0f172a}
header{background:var(--panel);padding:10px 14px;box-shadow:0 6px 18px rgba(2,6,23,0.06);position:sticky;top:0;z-index:20}
.top{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{font-size:18px;margin:0}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select,input[type=number],button{padding:8px;border-radius:8px;border:1px solid #d1d5db;background:#fff}
button.primary{background:var(--primary);color:#fff;border:none;cursor:pointer}
main{max-width:1200px;margin:16px auto;padding:0 14px;display:grid;grid-template-columns:1fr 380px;gap:16px}
@media (max-width:960px){main{grid-template-columns:1fr}}
.panel{background:var(--panel);border-radius:12px;padding:14px;box-shadow:0 8px 28px rgba(2,6,23,0.06)}
.stem{font-size:18px;font-weight:700;text-align:center}
.hint{font-size:13px;color:var(--muted);text-align:center;margin-top:6px}
.status{display:flex;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap}
.progress{flex:1;height:10px;background:#e6eef6;border-radius:999px;overflow:hidden}
.progress>i{display:block;height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));width:0%}
.options{display:grid;gap:10px;margin-top:12px}
@media (min-width:700px){.options{grid-template-columns:repeat(4,1fr)}}
.card{background:var(--primary);color:#fff;padding:12px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:86px;font-size:18px;cursor:pointer;user-select:none;transition:transform .12s}
.card.alt{background:#0ea5a4}
.card.correct{background:var(--ok)}
.card.wrong{background:var(--err)}
.rightCol .list{max-height:420px;overflow:auto;margin-top:8px}
.hotItem{display:flex;justify-content:space-between;padding:8px;border-radius:8px;background:#f8fafc;border:1px solid #e6eef6;margin-bottom:6px}
.small{font-size:13px;color:var(--muted)}
.kbd{display:flex;flex-wrap:wrap;gap:6px;padding:6px;border-radius:8px;background:#fbfcff;border:1px solid #e6eef6}
.kbd button{padding:6px 10px;border-radius:6px;border:1px solid #d1d5db;background:#fff;cursor:pointer}
.inputBox{display:flex;gap:8px;align-items:center;margin-top:10px}
input.pinyinInput{flex:1;padding:8px;border-radius:8px;border:1px solid #d1d5db}
.footer{text-align:center;color:var(--muted);margin-top:12px;font-size:13px}
.note{font-size:12px;color:var(--muted);margin-top:8px}
.uploader{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
textarea.large{width:100%;height:120px;border-radius:8px;border:1px solid #d1d5db;padding:8px}
</style>
</head>
<body>
  <header>
    <div class="top">
      <div>
        <h1>æ‹¼éŸ³ç»ƒä¹ å™¨</h1>
        <div class="small">åˆ†å±‚ï¼šå£°æ¯ / éŸµæ¯ / å®Œæ•´æ‹¼éŸ³ / å£°è°ƒ / æƒ…å¢ƒï¼ˆæ‹¼éŸ³é”®ç›˜ï¼‰ã€‚é»˜è®¤æ™®é€šè¯ï¼ˆzh-CNï¼‰ã€‚</div>
      </div>
      <div class="controls" aria-label="æ§åˆ¶åŒº">
        <label>æ¨¡å—ï¼š
          <select id="modeSelect">
            <option value="shengmu">å£°æ¯è¯†åˆ«</option>
            <option value="yunmu">éŸµæ¯è¯†åˆ«</option>
            <option value="pinyin" selected>å®Œæ•´æ‹¼éŸ³ï¼ˆå¬/çœ‹é€‰æ‹¼éŸ³ï¼‰</option>
            <option value="tone">å£°è°ƒè¾¨åˆ«</option>
            <option value="apply">æƒ…å¢ƒåº”ç”¨ï¼ˆæ‹¼éŸ³é”®ç›˜ï¼‰</option>
          </select>
        </label>
        <label>é¢˜æ•°ï¼š
          <select id="countSelect"><option>10</option><option selected>15</option><option>20</option></select>
        </label>
        <button id="startBtn" class="primary">å¼€å§‹ç»ƒä¹ </button>
        <button id="testBtn">æµ‹è¯•å‘éŸ³</button>
        <label>è¯­éŸ³ï¼š
          <select id="voiceSelect" title="è¯­éŸ³é€‰æ‹©ï¼ˆä¼˜å…ˆæ™®é€šè¯ï¼‰"></select>
        </label>
        <label>é€Ÿç‡:<input id="rate" type="number" min="0.6" max="1.4" step="0.05" value="0.95" style="width:80px"></label>
        <label>éŸ³é«˜:<input id="pitch" type="number" min="0.6" max="1.6" step="0.05" value="1" style="width:80px"></label>
      </div>
    </div>
  </header>

  <main>
    <section class="panel">
      <div id="stem" class="stem">ç‚¹å‡»â€œå¼€å§‹ç»ƒä¹ â€å¼€å§‹</div>
      <div id="hint" class="hint">æ¯ä¸ªæ±‰å­—ä¸‹æ–¹æ˜¾ç¤ºè¶Šå—è¯­é‡Šä¹‰ã€‚æƒ…å¢ƒæ¨¡å—æä¾›æ‹¼éŸ³é”®ç›˜ï¼ˆå«å¸¦è°ƒå…ƒéŸ³ï¼‰ã€‚</div>

      <div class="status">
        <div class="small">è¿›åº¦ <span id="progressText">0 / 0</span></div>
        <div class="progress" aria-hidden="true"><i id="progressFill"></i></div>
        <div class="small">å¾—åˆ† <span id="score">0</span></div>
      </div>

      <div id="options" class="options" aria-live="polite" style="margin-top:12px"></div>

      <div style="display:flex;gap:12px;justify-content:center;margin-top:12px;flex-wrap:wrap">
        <div class="small">å¹³å‡ç­”é¢˜æ—¶é—´ï¼š<span id="avgTime">â€”</span></div>
        <div class="small">æœ¬å±€ç”¨æ—¶ï¼š<span id="elapsed">0s</span></div>
      </div>

      <div style="margin-top:12px">
        <div class="note">å¯¼å…¥è¯´æ˜ï¼šå¦‚æœä½ æœ‰ HSK1+HSK2ï¼ˆ320è¯ï¼‰çš„ CSV æ–‡ä»¶ï¼ˆåˆ—ï¼šhanzi,pinyin,vnï¼‰ï¼Œç‚¹å‡»â€œé€‰æ‹© CSV å¹¶å¯¼å…¥â€å¯ä¸€æ¬¡æ€§åŠ è½½å®Œæ•´è¯åº“å¹¶ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨ã€‚ä¹Ÿå¯ç²˜è´´ CSV å†…å®¹åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†å¹¶ç‚¹å‡»â€œè§£æå¹¶å¯¼å…¥â€ã€‚</div>
        <div class="uploader">
          <input id="csvFile" type="file" accept=".csv,text/csv">
          <button id="importFileBtn">é€‰æ‹© CSV å¹¶å¯¼å…¥</button>
          <button id="pasteBtn">ç²˜è´´ CSV å¹¶å¯¼å…¥</button>
        </div>
        <textarea id="csvArea" class="large" placeholder="å¯ç²˜è´´ CSV å†…å®¹ï¼ˆæ¯è¡Œ hanzi,pinyin,vnï¼‰ï¼Œä¾‹å¦‚ï¼šçˆ¸çˆ¸,bÃ ba,bá»‘"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="parseBtn">è§£æå¹¶å¯¼å…¥ CSV</button>
          <button id="resetLib">æ¢å¤ç¤ºä¾‹è¯åº“ï¼ˆå°æ ·ä¾‹ï¼‰</button>
        </div>
      </div>
    </section>

    <aside class="panel rightCol">
      <div class="small">é”™é¢˜çƒ­æ¦œï¼ˆæœ¬æœºç´¯è®¡ï¼‰</div>
      <div id="hotList" class="list"></div>

      <div style="margin-top:12px" class="small">ä¼šè¯æ—¥å¿—</div>
      <div id="log" class="list"></div>

      <div style="margin-top:12px" class="small">å»ºè®®ï¼šä¸ºä¿è¯å‘éŸ³ä¸€è‡´æ€§ï¼Œç”Ÿäº§ç¯å¢ƒå¯æ›¿æ¢ä¸ºé¢„å½•éŸ³ï¼ˆaudio å­—æ®µï¼‰ã€‚åœ¨åº•éƒ¨æ³¨é‡Šæœ‰æ›¿æ¢ç¤ºä¾‹ã€‚</div>
    </aside>
  </main>

  <div class="footer">å•æ–‡ä»¶ç¦»çº¿è¿è¡Œ Â· æ”¯æŒå¯¼å…¥å®Œæ•´ HSK1+HSK2 è¯åº“å¹¶ä¿å­˜åˆ°æœ¬åœ°ï¼ˆlocalStorageï¼‰ã€‚</div>

<script>
/* ===========================
   æ ¸å¿ƒè„šæœ¬ï¼šæ‹¼éŸ³ç»ƒä¹ å™¨
   - æ”¯æŒå¯¼å…¥ CSVï¼ˆhanzi,pinyin,vnï¼‰
   - æƒ…å¢ƒæ¨¡å—ä½¿ç”¨æ‹¼éŸ³é”®ç›˜è¾“å…¥ï¼ˆå¸¦è°ƒç¬¦å·ï¼‰
   - ç”¨æ±‰å­—ï¼ˆhanziï¼‰ä½œä¸º TTS æ–‡æœ¬ä»¥æé«˜æ™®é€šè¯å‡†ç¡®æ€§
   - é”™é¢˜ç»Ÿè®¡ä¿å­˜åˆ° localStorage
   =========================== */

/* ======= é»˜è®¤ç¤ºä¾‹è¯åº“ï¼ˆå°æ ·ä¾‹ï¼‰ =======
   ä¸ºé¿å…è¯åº“å¤§ä¸”ç¿»è¯‘ä¸å‡†ç¡®ï¼Œé¡µé¢åˆå§‹ä»…åŒ…å«å°‘é‡ç¤ºä¾‹æ¡ç›®ã€‚
   è¯·ä½¿ç”¨é¡µé¢å¯¼å…¥åŠŸèƒ½åŠ è½½å®Œæ•´çš„ HSK1+HSK2ï¼ˆ320è¯ï¼‰CSVã€‚
*/
let WORDS = [
  {hanzi:'çˆ¸çˆ¸', pinyin:'bÃ ba', vn:'bá»‘'},
  {hanzi:'å¦ˆå¦ˆ', pinyin:'mÄma', vn:'máº¹'},
  {hanzi:'ä½ å¥½', pinyin:'nÇhÇo', vn:'xin chÃ o'},
  {hanzi:'è°¢è°¢', pinyin:'xiÃ¨xie', vn:'cáº£m Æ¡n'},
  {hanzi:'å¦¹å¦¹', pinyin:'mÃ¨imei', vn:'em gÃ¡i'},
  {hanzi:'å“¥å“¥', pinyin:'gÄ“ge', vn:'anh trai'},
  {hanzi:'å­¦ä¹ ', pinyin:'xuÃ©xÃ­', vn:'há»c táº­p'},
  {hanzi:'å­¦æ ¡', pinyin:'xuÃ©xiÃ o', vn:'trÆ°á»ng há»c'}
];

/* å£°æ¯/éŸµæ¯æ•™å­¦å­é›† */
const SHENGMU = ['b','p','m','f','d','t','n','l','g','k','h','j','q','x','zh','ch','sh','r','z','c','s','y','w'];
const YUNMU  = ['a','o','e','i','u','Ã¼','ai','ei','ao','ou','an','en','ang','eng','ong','iao','iu','ian','iang','ing','iong'];

/* DOM å…ƒç´  */
const modeSelect = document.getElementById('modeSelect');
const countSelect = document.getElementById('countSelect');
const startBtn = document.getElementById('startBtn');
const testBtn = document.getElementById('testBtn');
const voiceSelect = document.getElementById('voiceSelect');
const rateInput = document.getElementById('rate');
const pitchInput = document.getElementById('pitch');

const stemEl = document.getElementById('stem');
const hintEl = document.getElementById('hint');
const optionsEl = document.getElementById('options');
const progressText = document.getElementById('progressText');
const progressFill = document.getElementById('progressFill');
const scoreEl = document.getElementById('score');
const avgTimeEl = document.getElementById('avgTime');
const elapsedEl = document.getElementById('elapsed');
const hotListEl = document.getElementById('hotList');
const logEl = document.getElementById('log');

const csvFile = document.getElementById('csvFile');
const importFileBtn = document.getElementById('importFileBtn');
const pasteBtn = document.getElementById('pasteBtn');
const csvArea = document.getElementById('csvArea');
const parseBtn = document.getElementById('parseBtn');
const resetLibBtn = document.getElementById('resetLib');

/* è¯­éŸ³åˆ—è¡¨ */
let voices = [];
function populateVoices(){
  if(!('speechSynthesis' in window)) return;
  voices = speechSynthesis.getVoices() || [];
  voiceSelect.innerHTML = '';
  voices.forEach(v=>{
    const o = document.createElement('option'); o.value = v.voiceURI; o.textContent = `${v.name} â€” ${v.lang}`;
    voiceSelect.appendChild(o);
  });
  const zh = voices.find(v=>v.lang && v.lang.toLowerCase().startsWith('zh'));
  if(zh) voiceSelect.value = zh.voiceURI;
  else if(voices[0]) voiceSelect.value = voices[0].voiceURI;
}
if('speechSynthesis' in window){ populateVoices(); speechSynthesis.onvoiceschanged = populateVoices; }
else { voiceSelect.innerHTML = '<option>ä¸æ”¯æŒ SpeechSynthesis</option>'; }

/* localStorage ç»Ÿè®¡ */
const LS_KEY = 'pinyin_practice_stats_v1';
let stats = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
function saveStats(){ localStorage.setItem(LS_KEY, JSON.stringify(stats)); }
function incStats(key, correct){
  stats[key] = stats[key] || { right:0, wrong:0 };
  if(correct) stats[key].right++; else stats[key].wrong++;
  saveStats(); renderHotList();
}

/* session state */
let session = { total:15, idx:0, score:0, times:[], startAt:0, lastMark:0, reviewQueue:[], pool:[] };
let currentQ = null;
let timerId = null;

/* utilities */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function now(){ return Date.now(); }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeForJs(s){ return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,'\\n'); }

/* speak by hanzi (improves pronunciation accuracy) */
function speakHanzi(hanzi){
  if(!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(hanzi);
  u.lang = 'zh-CN';
  const sel = voiceSelect.value;
  if(sel && voices.length){
    const v = voices.find(x=>x.voiceURI === sel);
    if(v) u.voice = v;
  } else {
    const auto = voices.find(x=>x.lang && x.lang.toLowerCase().startsWith('zh'));
    if(auto) u.voice = auto;
  }
  u.rate = parseFloat(rateInput.value || 0.95);
  u.pitch = parseFloat(pitchInput.value || 1);
  window.speechSynthesis.speak(u);
}

/* build session pool (random selection) */
function buildSessionPool(){
  const total = Math.min(WORDS.length, session.total);
  const arr = WORDS.slice();
  shuffle(arr);
  session.pool = arr.slice(0, total);
}

/* pick from pool with rotation */
function pickFromPool(){
  if(!session.pool || session.pool.length === 0) buildSessionPool();
  const w = session.pool.shift();
  session.pool.push(w);
  return w;
}

/* genQuestion: returns {key, stem, speak, options, type, meta} */
function genQuestion(mode){
  if(mode === 'shengmu'){
    const w = pickFromPool();
    const syll = w.pinyin.split(/[\s-]/)[0].toLowerCase();
    let initial = '';
    const multi = ['zh','ch','sh'];
    for(const m of multi){ if(syll.startsWith(m)){ initial = m; break; } }
    if(!initial){ initial = (SHENGMU.includes(syll[0])? syll[0] : '(æ— å£°æ¯)'); }
    const choices = shuffle([initial, ...randPick(SHENGMU.filter(s=>s!==initial),3)]);
    return { key:`SM|${w.hanzi}|${initial}`, stem:`å£°æ¯ï¼šè¯·é—® <b>${w.hanzi}</b>ï¼ˆ${w.vn}ï¼‰é¦–éŸ³èŠ‚çš„å£°æ¯æ˜¯ï¼Ÿ`, speak:w.hanzi, options:choices.map(c=>({label:c,correct:c===initial})), type:'shengmu', meta:{word:w} };
  }

  if(mode === 'yunmu'){
    const w = pickFromPool();
    let syll = w.pinyin.split(/[\s-]/)[0].toLowerCase();
    for(const s of SHENGMU){ if(syll.startsWith(s)){ syll = syll.slice(s.length); break; } }
    const ym = syll || 'a';
    const choices = shuffle([ym, ...randPick(YUNMU.filter(x=>x!==ym),3)]);
    return { key:`YM|${w.hanzi}|${ym}`, stem:`éŸµæ¯ï¼šè¯·é—® <b>${w.hanzi}</b>ï¼ˆ${w.vn}ï¼‰é¦–éŸ³èŠ‚çš„éŸµæ¯æ˜¯ï¼Ÿ`, speak:w.hanzi, options:choices.map(c=>({label:c,correct:c===ym})), type:'yunmu', meta:{word:w} };
  }

  if(mode === 'pinyin'){
    const w = pickFromPool();
    const correct = w.pinyin;
    const distract = randPick(WORDS.filter(x=>x.hanzi !== w.hanzi),3).map(x=>x.pinyin);
    const opts = shuffle([correct, ...distract]).map(p=>({label:p,correct:p===correct}));
    return { key:`PY|${w.hanzi}|${correct}`, stem:`æ‹¼éŸ³ï¼šè¯·é€‰æ‹©ä¸ <b>${w.hanzi}</b>ï¼ˆ${w.vn}ï¼‰å¯¹åº”çš„æ‹¼éŸ³ï¼š`, speak:w.hanzi, options:opts, type:'pinyin', meta:{word:w} };
  }

  if(mode === 'tone'){
    const w = pickFromPool();
    const first = w.pinyin.split(/[\s-]/)[0];
    const tone = detectToneFromMarked(first) || 1;
    const choices = shuffle([1,2,3,4]).map(n=>({label:`ç¬¬ ${n} å£°`, correct:n===tone}));
    return { key:`TN|${w.hanzi}|${tone}`, stem:`å£°è°ƒï¼šåˆ¤æ–­ <b>${w.hanzi}</b>ï¼ˆ${w.vn}ï¼‰ç¬¬ä¸€ä¸ªéŸ³èŠ‚çš„å£°è°ƒï¼š`, speak:w.hanzi, options:choices, type:'tone', meta:{word:w} };
  }

  if(mode === 'apply'){
    const w = pickFromPool();
    return { key:`AP|${w.hanzi}|${w.pinyin}`, stem:`æƒ…å¢ƒï¼šè¯·ä¸º <b>${w.hanzi}</b>ï¼ˆ${w.vn}ï¼‰ä½¿ç”¨ä¸‹æ–¹æ‹¼éŸ³é”®ç›˜è¾“å…¥å¸¦å£°è°ƒçš„æ‹¼éŸ³ï¼Œç„¶åç‚¹å‡»æäº¤ï¼š`, speak:w.hanzi, options:[{label:'__INPUT__',meta:{answer:w.pinyin}}], type:'apply', meta:{word:w} };
  }

  return null;
}

function randPick(arr,n){ const a = arr.slice(); const out = []; while(out.length < n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; }

/* detect tone from marked pinyin */
function detectToneFromMarked(p){
  const m1='ÄÄ“Ä«ÅÅ«Ç–Ä€Ä’ÄªÅŒÅª', m2='Ã¡Ã©Ã­Ã³ÃºÇ˜ÃÃ‰ÃÃ“Ãš', m3='ÇÄ›ÇÇ’Ç”ÇšÇÄšÇÇ‘Ç“', m4='Ã Ã¨Ã¬Ã²Ã¹ÇœÃ€ÃˆÃŒÃ’Ã™';
  for(const ch of p){ if(m1.includes(ch)) return 1; if(m2.includes(ch)) return 2; if(m3.includes(ch)) return 3; if(m4.includes(ch)) return 4; }
  return 0;
}

/* ===== render & quiz flow ===== */
function startPractice(){
  session.total = Math.min(parseInt(countSelect.value,10)||15, WORDS.length);
  session.idx = 0; session.score = 0; session.times = []; session.reviewQueue = [];
  session.startAt = now(); session.lastMark = now();
  buildSessionPool();
  nextQuestion();
  startTimer();
  pushLog(`å¼€å§‹ç»ƒä¹ ï¼šæ¨¡å—=${modeSelect.value}ï¼›é¢˜æ•°=${session.total}`);
}

function nextQuestion(){
  if(session.idx >= session.total){ finishSession(); return; }
  if(session.reviewQueue.length) currentQ = session.reviewQueue.shift();
  else currentQ = genQuestion(modeSelect.value);
  session.idx++;
  renderCurrent();
  updateHUD();
  session.lastMark = now();
}

function renderCurrent(){
  optionsEl.innerHTML = '';
  if(!currentQ){ stemEl.textContent = 'é¢˜ç›®ç”Ÿæˆå¤±è´¥'; return; }
  stemEl.innerHTML = currentQ.stem + ` <button style="margin-left:8px;padding:5px;border-radius:6px" onclick="speakHanzi('${escapeForJs(currentQ.speak)}')">ğŸ”Š å‘éŸ³</button>`;

  if(currentQ.type === 'apply'){
    const container = document.createElement('div');
    const inputRow = document.createElement('div'); inputRow.className='inputBox';
    const input = document.createElement('input'); input.className='pinyinInput'; input.type='text'; input.readOnly = true;
    const clearBtn = document.createElement('button'); clearBtn.textContent='æ¸…ç©º'; clearBtn.onclick = ()=>{ input.value=''; input.focus(); };
    const submitBtn = document.createElement('button'); submitBtn.className='primary'; submitBtn.textContent='æäº¤';
    submitBtn.onclick = ()=>submitInput(input.value.trim());
    inputRow.appendChild(input); inputRow.appendChild(clearBtn); inputRow.appendChild(submitBtn);
    container.appendChild(inputRow);

    const kb = document.createElement('div'); kb.className='kbd'; kb.style.marginTop='8px';
    const keys = [
      'b','p','m','f','d','t','n','l','g','k','h','j','q','x','zh','ch','sh','r','z','c','s','y','w',
      'a','o','e','i','u','Ã¼',
      'Ä','Ã¡','Ç','Ã ','Ä“','Ã©','Ä›','Ã¨','Ä«','Ã­','Ç','Ã¬','Å','Ã³','Ç’','Ã²','Å«','Ãº','Ç”','Ã¹','Ç–','Ç˜','Çš','Çœ',
      'Â·'
    ];
    keys.forEach(k=>{
      const btn = document.createElement('button'); btn.textContent = k;
      btn.onclick = ()=>{ input.value += k; input.focus(); };
      kb.appendChild(btn);
    });
    const back = document.createElement('button'); back.textContent='âŒ«'; back.onclick = ()=>{ input.value = input.value.slice(0,-1); input.focus(); };
    kb.appendChild(back);
    container.appendChild(kb);
    optionsEl.appendChild(container);
    return;
  }

  currentQ.options.forEach((o, idx)=>{
    const d = document.createElement('div'); d.className='card' + (idx%2===0 ? ' alt' : '');
    d.innerHTML = `<div>${escapeHtml(o.label)}</div><div class="small" style="margin-top:6px">${currentQ.type==='pinyin'?'æ‹¼éŸ³':''}</div>`;
    d.onclick = ()=>submitChoice(o.correct, d);
    optionsEl.appendChild(d);
  });
}

function submitChoice(isCorrect, dom){
  const t = (now() - session.lastMark)/1000; session.times.push(t);
  if(isCorrect){ dom.classList.add('correct'); speakHanzi(currentQ.speak); }
  else { dom.classList.add('wrong'); setTimeout(()=>dom.classList.remove('wrong'),700); }
  handleResult(isCorrect);
}

function submitInput(val){
  const t = (now() - session.lastMark)/1000; session.times.push(t);
  const expected = currentQ.meta.word.pinyin;
  const u = normalizePinyinString(val);
  const e = normalizePinyinString(expected);
  const correct = (u === e);
  handleResult(correct);
}

function normalizePinyinString(s){
  if(!s) return '';
  return String(s).normalize('NFC').replace(/\s+/g,'').toLowerCase();
}

function handleResult(correct){
  if(correct){
    session.score++; incStats(currentQ.key, true); pushLog(`âœ” æ­£ç¡®ï¼š${currentQ.key}`);
  } else {
    incStats(currentQ.key, false); session.reviewQueue.push(currentQ); pushLog(`âœ˜ é”™è¯¯ï¼š${currentQ.key}`);
  }
  updateHUD();
  setTimeout(()=> nextQuestion(), 500);
}

function finishSession(){
  stopTimer();
  const used = Math.round((now() - session.startAt)/1000);
  stemEl.innerHTML = `æœ¬è½®å®Œæˆï¼å¾—åˆ† ${session.score} / ${session.total}ï¼Œç”¨æ—¶ ${used}s`;
  pushLog(`æœ¬è½®ç»“æŸï¼š${session.score}/${session.total}ï¼Œç”¨æ—¶ ${used}s`);
}

/* HUD, timer, logs */
function updateHUD(){
  progressText.textContent = `${Math.min(session.idx, session.total)} / ${session.total}`;
  const pct = session.total ? Math.round(Math.min(100,(session.idx/session.total)*100)) : 0;
  progressFill.style.width = pct + '%';
  scoreEl.textContent = session.score;
  const avg = session.times.length ? (session.times.reduce((a,b)=>a+b,0)/session.times.length) : 0;
  avgTimeEl.textContent = session.times.length ? `${avg.toFixed(1)}s` : 'â€”';
}
function startTimer(){ if(timerId) clearInterval(timerId); timerId = setInterval(()=>{ elapsedEl.textContent = Math.round((now()-session.startAt)/1000) + 's'; },500); }
function stopTimer(){ if(timerId) clearInterval(timerId); timerId = null; }

function renderHotList(){
  hotListEl.innerHTML = '';
  const arr = Object.entries(stats).map(([k,v])=>({k,k2:k.split('|')[1]||k,w:v.wrong||0,r:v.right||0})).sort((a,b)=>b.w-a.w);
  arr.slice(0,20).forEach(it=>{
    const d = document.createElement('div'); d.className='hotItem';
    d.innerHTML = `<div>${escapeHtml(it.k2)}</div><div class="small">é”™ ${it.w}</div>`;
    hotListEl.appendChild(d);
  });
}
function pushLog(text){ const d=document.createElement('div'); d.textContent = `${new Date().toLocaleTimeString()} â€” ${text}`; logEl.prepend(d); if(logEl.children.length>500) logEl.removeChild(logEl.lastChild); }

/* events */
startBtn.addEventListener('click', ()=>{
  session.total = Math.min(parseInt(countSelect.value,10)||15, WORDS.length);
  session.idx = 0; session.score = 0; session.times = []; session.reviewQueue = [];
  session.startAt = now(); session.lastMark = now();
  buildSessionPool();
  nextQuestion();
  startTimer();
  pushLog(`å¼€å§‹ç»ƒä¹ ï¼šæ¨¡å—=${modeSelect.value}ï¼›é¢˜æ•°=${session.total}`);
});
testBtn.addEventListener('click', ()=>{ speakHanzi('ä½ å¥½'); });

/* CSV import handlers */
importFileBtn.addEventListener('click', ()=> csvFile.click());
csvFile.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{ csvArea.value = reader.result; parseCsvAndImport(reader.result); };
  reader.readAsText(f,'utf-8');
});
pasteBtn.addEventListener('click', ()=>{ csvArea.focus(); alert('è¯·å°† CSV å†…å®¹ç²˜è´´åˆ°ä¸‹æ–¹æ–‡æœ¬æ¡†ï¼Œå¹¶ç‚¹å‡»â€œè§£æå¹¶å¯¼å…¥ CSVâ€ã€‚'); });
parseBtn.addEventListener('click', ()=>{ const txt = csvArea.value.trim(); if(!txt){ alert('è¯·å…ˆç²˜è´´æˆ–åŠ è½½ CSV å†…å®¹'); return; } parseCsvAndImport(txt); });
resetLibBtn.addEventListener('click', ()=>{
  if(!confirm('æ¢å¤ç¤ºä¾‹è¯åº“ï¼ˆä¼šä¸¢å¤±å½“å‰æœªä¿å­˜çš„è¯åº“ï¼‰ï¼Ÿ')) return;
  WORDS = [
    {hanzi:'çˆ¸çˆ¸', pinyin:'bÃ ba', vn:'bá»‘'},
    {hanzi:'å¦ˆå¦ˆ', pinyin:'mÄma', vn:'máº¹'},
    {hanzi:'ä½ å¥½', pinyin:'nÇhÇo', vn:'xin chÃ o'},
    {hanzi:'è°¢è°¢', pinyin:'xiÃ¨xie', vn:'cáº£m Æ¡n'},
    {hanzi:'å¦¹å¦¹', pinyin:'mÃ¨imei', vn:'em gÃ¡i'},
    {hanzi:'å“¥å“¥', pinyin:'gÄ“ge', vn:'anh trai'},
    {hanzi:'å­¦ä¹ ', pinyin:'xuÃ©xÃ­', vn:'há»c táº­p'},
    {hanzi:'å­¦æ ¡', pinyin:'xuÃ©xiÃ o', vn:'trÆ°á»ng há»c'}
  ];
  localStorage.removeItem('pinyin_practice_words_v1');
  pushLog('å·²æ¢å¤ç¤ºä¾‹è¯åº“');
});

/* parse CSV: supports hanzi,pinyin,vn per line. Ignores header if any. */
function parseCsvAndImport(csvText){
  // Basic CSV parser: split lines, split on comma, allow commas in quotes
  const lines = csvText.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  if(!lines.length){ alert('CSV å†…å®¹ä¸ºç©º'); return; }
  const parsed = [];
  for(const line of lines){
    // naive CSV split respecting quotes
    const cols = [];
    let cur = ''; let inQ = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(ch === '"' ){ inQ = !inQ; continue; }
      if(ch === ',' && !inQ){ cols.push(cur); cur=''; continue; }
      cur += ch;
    }
    cols.push(cur);
    // map first three columns
    const hanzi = (cols[0]||'').trim();
    const pinyin = (cols[1]||'').trim();
    const vn = (cols[2]||'').trim();
    if(!hanzi || !pinyin){
      // skip invalid row
      continue;
    }
    parsed.push({hanzi, pinyin, vn});
  }
  if(parsed.length === 0){ alert('æœªè§£æåˆ°æœ‰æ•ˆè¡Œï¼Œç¡®ä¿ CSV æ¯è¡Œè‡³å°‘åŒ…å« hanzi,pinyin'); return; }
  // save to WORDS and localStorage
  WORDS = parsed;
  localStorage.setItem('pinyin_practice_words_v1', JSON.stringify(WORDS));
  pushLog(`å·²å¯¼å…¥ ${WORDS.length} æ¡è¯æ¡ï¼ˆè¯·æ£€æŸ¥è¶Šå—è¯­åˆ—æ˜¯å¦å®Œæ•´ï¼‰`);
  alert(`å·²å¯¼å…¥ ${WORDS.length} æ¡è¯æ¡`);
  // clear any ongoing session
  session.pool = [];
}

/* load saved words if any */
(function loadSavedWords(){
  try{
    const saved = localStorage.getItem('pinyin_practice_words_v1');
    if(saved){
      const parsed = JSON.parse(saved);
      if(Array.isArray(parsed) && parsed.length>0) WORDS = parsed;
    }
  }catch(e){}
})();

/* initial render */
function renderHotList(){ hotListEl.innerHTML=''; const arr = Object.entries(stats).map(([k,v])=>({k,k2:k.split('|')[1]||k,w:v.wrong||0})).sort((a,b)=>b.w-a.w); arr.slice(0,20).forEach(it=>{ const d=document.createElement('div'); d.className='hotItem'; d.innerHTML=`<div>${escapeHtml(it.k2)}</div><div class="small">é”™ ${it.w}</div>`; hotListEl.appendChild(d); }); }
function pushLog(text){ const d=document.createElement('div'); d.textContent = `${new Date().toLocaleTimeString()} â€” ${text}`; logEl.prepend(d); if(logEl.children.length>500) logEl.removeChild(logEl.lastChild); }

window.addEventListener('load', ()=>{
  setTimeout(()=>{ if('speechSynthesis' in window) populateVoices(); }, 300);
  renderHotList();
  pushLog('é¡µé¢å·²å°±ç»ª');
});

/* ========== å¼€å‘è€…ï¼šå¦‚ä½•æ‰©å±• & æ›¿æ¢éŸ³é¢‘ï¼ˆæ³¨é‡Šï¼‰ ==========
1) æ‰©å±•/æ›¿æ¢è¯åº“ï¼ˆHSK1/HSK2ï¼‰ï¼š
   - å‡†å¤‡ CSV æ–‡ä»¶ï¼Œæ ¼å¼ï¼ˆä¸éœ€è¦è¡¨å¤´ï¼Œä½†å¯æœ‰ï¼‰ï¼š
       hanzi,pinyin,vn
     ä¾‹å¦‚ï¼š
       çˆ¸çˆ¸,bÃ ba,bá»‘
       å¦ˆå¦ˆ,mÄma,máº¹
   - ç‚¹å‡»é¡µé¢çš„â€œé€‰æ‹© CSV å¹¶å¯¼å…¥â€æˆ–ç²˜è´´ CSV æ–‡æœ¬å¹¶ç‚¹å‡»â€œè§£æå¹¶å¯¼å…¥ CSVâ€ã€‚
   - å¯¼å…¥åè¯åº“ä¼šä¿å­˜åˆ° localStorageï¼ˆé”®åï¼špinyin_practice_words_v1ï¼‰ã€‚

2) æ›¿æ¢ä¸ºé¢„å½•éŸ³ï¼ˆç¡®ä¿å‘éŸ³ 100% ä¸€è‡´ï¼‰ï¼š
   - åœ¨ CSV ä¸­åŠ å…¥ç¬¬å››åˆ— audioï¼Œå€¼å¯ä»¥æ˜¯ç›¸å¯¹æ–‡ä»¶åæˆ– data URIï¼ˆbase64ï¼‰ã€‚
   - ä¿®æ”¹ä»£ç ä¸­çš„ speakHanzi å‡½æ•°ç¤ºä¾‹ï¼š
       function speakHanzi(hanzi){
         const item = WORDS.find(w=>w.hanzi === hanzi);
         if(item && item.audio){
           const a = new Audio(item.audio);
           a.play();
           return;
         }
         // å¦åˆ™å›é€€åˆ° speechSynthesisï¼ˆå½“å‰å®ç°ï¼‰
       }
   - è‹¥ä½¿ç”¨ data:audio;base64,...ï¼Œæ–‡ä»¶ä»ä¸ºå•æ–‡ä»¶å³å¯ç¦»çº¿è¿è¡Œï¼ˆæ–‡ä»¶ä¼šæ›´å¤§ï¼‰ã€‚

3) å¯¼å‡º/å¯¼å…¥æ•™å¸ˆæ•°æ®ä¸ SRSï¼š
   - å¯åœ¨æœ¬é¡µæ‰©å±•â€œå¯¼å‡ºé”™é¢˜ç»Ÿè®¡â€ä¸º CSVï¼ˆä» stats å¯¹è±¡äº§ç”Ÿï¼‰ã€‚
   - å¯æŠŠ stats ä¸­çš„ä¿¡æ¯ï¼ˆé”™è¯¯æ¬¡æ•°ã€æ­£ç¡®æ¬¡æ•°ã€SM-2 å‚æ•°ï¼‰åºåˆ—åŒ–ï¼Œä¾›æ•™å¸ˆå¯¼å…¥åˆ°å…¶ä»–å·¥å…·ã€‚

4) ç”Ÿæˆå®Œæ•´ HSK1 + HSK2 320 è¯æ¡ï¼ˆå«è¶Šå—è¯­é‡Šä¹‰ï¼‰ï¼š
   - è‹¥ä½ å¸Œæœ›æˆ‘ä»£ä¸ºç”Ÿæˆå¹¶æ ¡å¯¹ 320 æ¡è¶Šå—è¯­é‡Šä¹‰ï¼Œæˆ‘å¯ä»¥åˆ†æ‰¹ï¼ˆä¾‹å¦‚æ¯æ¬¡ 50 æ¡ï¼‰é€æ­¥ç”Ÿæˆå¹¶è®©ä½ ç¡®è®¤ï¼Œä»¥ä¿è¯ç¿»è¯‘å‡†ç¡®æ— è¯¯ã€‚è¯·å›å¤ç¡®è®¤å¼€å§‹è¯¥å·¥ä½œã€‚

============================================================================ */
</script>
</body>
</html>
